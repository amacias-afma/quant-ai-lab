<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hybrid Risk Engine</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }

        .card {
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .breach-box {
            border-left: 5px solid #dc3545;
            background-color: #fff5f5;
        }

        .safe-box {
            border-left: 5px solid #198754;
            background-color: #f0fff4;
        }

        .table-success-soft {
            background-color: #f0fff4;
        }
    </style>
</head>

<body>

    <div class="container py-5">

        <div class="text-center mb-5">
            <h1 class="fw-bold text-primary">Quant Risk Lab</h1>
            <p class="text-muted">Basel III Capital Efficiency: Econometrics vs Deep Learning</p>
        </div>

        <div class="accordion mb-5" id="accordionExample">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingOne">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseOne">
                        <strong>üì¢ The Business Case: Why Volatility Modeling Matters</strong>
                    </button>
                </h2>
                <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                    <div class="accordion-body">
                        <div class="row align-items-center">
                            <div class="col-md-7">
                                <h5>The Basel III Problem</h5>
                                <p>Banks must hold capital buffers (VaR) to cover potential losses.
                                    If a model reacts too slowly to a crash, the bank holds too little capital and faces
                                    regulatory fines ("Breach").</p>
                                <p><strong>Goal:</strong> Create a "Smart Shield" that stays low during calm markets
                                    (saving money) but spikes instantly before a crash (saving the bank).</p>
                            </div>
                            <div class="col-md-5">
                                <div class="card p-3 bg-light border">
                                    <small class="text-muted text-uppercase fw-bold">Simulation: $10M Portfolio</small>
                                    <div class="d-flex justify-content-between mt-2">
                                        <span>üìâ Market Shock:</span>
                                        <span class="text-danger fw-bold">-$400,000 Loss</span>
                                    </div>
                                    <hr class="my-2">
                                    <div class="d-flex justify-content-between">
                                        <span>üê¢ GARCH Shield:</span>
                                        <span class="text-danger">$279k (BREACH)</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>üöÄ LSTM Shield:</span>
                                        <span class="text-success">$815k (SAFE)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row justify-content-center mb-4">
            <div class="col-md-6">
                <div class="card p-4">
                    <label class="form-label fw-bold">Select Portfolio Asset ($1M Notional)</label>
                    <div class="input-group">
                        <select id="tickerInput" class="form-select">
                            <option selected disabled>Loading assets...</option>
                        </select>
                        <button class="btn btn-primary" onclick="runAnalysis()">Run Backtest</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="resultsArea" style="display: none;">

            <div class="text-center mb-4">
                <h3 id="assetTitle" class="fw-bold">--</h3>
            </div>

            <div class="card p-4 mb-4">
                <h5 class="card-title fw-bold mb-3">üìä Capital Efficiency Report (Last 100 Days)</h5>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Model</th>
                                <th>Avg Capital Held</th>
                                <th>Efficiency vs Perfect</th>
                                <th>Regulatory Breaches</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="fw-bold text-danger">Benchmark (GARCH)</td>
                                <td id="garchCap">--</td>
                                <td id="garchEff" class="text-muted">--</td>
                                <td id="garchBreach">--</td>
                                <td><span class="badge bg-secondary">Standard</span></td>
                            </tr>
                            <tr class="table-success-soft">
                                <td class="fw-bold text-success">Challenger (Deep LSTM)</td>
                                <td id="lstmCap">--</td>
                                <td id="lstmEff" class="fw-bold text-success">--</td>
                                <td id="lstmBreach">--</td>
                                <td><span class="badge bg-success">Recommended</span></td>
                            </tr>
                            <tr class="text-muted small">
                                <td><i>Realized (Perfect Sight)</i></td>
                                <td id="realCap">--</td>
                                <td><i>Baseline</i></td>
                                <td><i>0</i></td>
                                <td><i>Target</i></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card p-4">
                <h5 class="card-title fw-bold">üõ°Ô∏è Capital Shield Analysis</h5>
                <p class="text-muted small">
                    Bars = <strong>Daily Loss</strong> (Positive magnitude of negative returns).<br>
                    Lines = <strong>Required Capital (VaR)</strong>. If a Bar rises above the Line, it is a
                    <strong>Regulatory Breach</strong>.
                </p>
                <canvas id="riskChart" height="120"></canvas>
            </div>
        </div>
    </div>
    <div class="card p-4 mb-4">
        <h5 class="card-title fw-bold mb-3">üìä Model Validation Report (Last 100 Days)</h5>
        <div class="table-responsive">
            <table class="table table-bordered align-middle text-center">
                <thead class="table-light">
                    <tr>
                        <th>Model</th>
                        <th>Target Breach %</th>
                        <th>Actual Breach %</th>
                        <th>Result (Coverage)</th>
                        <th>Avg Capital Held</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="text-muted">
                        <td class="text-start fw-bold">Historical (Basic)</td>
                        <td>1.0%</td>
                        <td id="histRate">--</td>
                        <td id="histStatus">--</td>
                        <td id="histCap">--</td>
                    </tr>
                    <tr>
                        <td class="text-start fw-bold text-danger">GARCH (Parametric)</td>
                        <td>1.0%</td>
                        <td id="garchRate">--</td>
                        <td id="garchStatus">--</td>
                        <td id="garchCap">--</td>
                    </tr>
                    <tr class="table-success-soft">
                        <td class="text-start fw-bold text-success">Deep LSTM (AI)</td>
                        <td>1.0%</td>
                        <td id="lstmRate">--</td>
                        <td id="lstmStatus">--</td>
                        <td id="lstmCap">--</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="text-end text-muted small">
            * <strong>Coverage Test:</strong> If "Actual %" > 1%, the model is dangerous (Under-estimating). <br>
            If "Actual %" < 1%, the model is safe but expensive (Over-estimating). <strong>Closer to 1% is
                better.</strong>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async () => await loadTickers());

        async function loadTickers() {
            const res = await fetch('/tickers');
            const data = await res.json();
            const sel = document.getElementById('tickerInput');
            sel.innerHTML = '<option selected disabled>Select Asset</option>';
            data.forEach(item => {
                let opt = document.createElement('option');
                opt.value = item.code;
                opt.text = `${item.name} (${item.code})`; // Name + Code
                sel.appendChild(opt);
            });
        }

        let chart = null;

        async function runAnalysis() {
            const ticker = document.getElementById('tickerInput').value;
            const res = await fetch('/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ticker: ticker })
            });
            const data = await res.json();

            // Update Title
            document.getElementById('assetTitle').innerText = `${data.asset_name} (${data.ticker})`;
            const m = data.metrics;
            const fmt = (n) => "$" + n.toLocaleString(undefined, { maximumFractionDigits: 0 });

            // Function to check calibration
            function getStatus(rate) {
                if (rate > 2.0) return '<span class="badge bg-danger">Dangerous (>2%)</span>';
                if (rate > 1.0) return '<span class="badge bg-warning text-dark">Slight Breach</span>';
                if (rate === 0) return '<span class="badge bg-info">Conservative (0%)</span>';
                return '<span class="badge bg-success">Calibrated (~1%)</span>';
            }

            // Historical Row
            document.getElementById('histRate').innerText = m.hist_rate.toFixed(1) + "%";
            document.getElementById('histStatus').innerHTML = getStatus(m.hist_rate);
            document.getElementById('histCap').innerText = fmt(m.hist_cap);

            // GARCH Row
            document.getElementById('garchRate').innerText = m.garch_rate.toFixed(1) + "%";
            document.getElementById('garchStatus').innerHTML = getStatus(m.garch_rate);
            document.getElementById('garchCap').innerText = fmt(m.garch_cap);

            // LSTM Row
            document.getElementById('lstmRate').innerText = m.lstm_rate.toFixed(1) + "%";
            document.getElementById('lstmStatus').innerHTML = getStatus(m.lstm_rate);
            document.getElementById('lstmCap').innerText = fmt(m.lstm_cap);

            // Update Chart
            const ctx = document.getElementById('riskChart').getContext('2d');
            if (chart) chart.destroy();

            const losses = data.plot_data.pnl.map(p => p < 0 ? Math.abs(p) : 0);

            chart = new Chart(ctx, {
                data: {
                    labels: data.plot_data.dates,
                    datasets: [
                        {
                            type: 'bar',
                            label: 'Daily Loss',
                            data: losses,
                            backgroundColor: 'rgba(108, 117, 125, 0.4)',
                            order: 4
                        },
                        {
                            type: 'line',
                            label: 'Historical VaR (Basic)',
                            data: data.plot_data.hist_var,
                            borderColor: '#6c757d', // Grey
                            borderDash: [5, 5],
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0, // Stair-step often better for Hist VaR, but line is fine
                            order: 3
                        },
                        {
                            type: 'line',
                            label: 'GARCH VaR',
                            data: data.plot_data.garch_var,
                            borderColor: '#dc3545',
                            borderWidth: 2,
                            pointRadius: 0,
                            order: 2
                        },
                        {
                            type: 'line',
                            label: 'LSTM VaR',
                            data: data.plot_data.lstm_var,
                            borderColor: '#198754',
                            borderWidth: 2,
                            pointRadius: 0,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        tooltip: { callbacks: { label: (c) => c.dataset.label + ': $' + Math.round(c.raw).toLocaleString() } }
                    }
                }
            });

            // // Fill Table
            // const m = data.metrics;
            // const fmt = (n) => "$" + n.toLocaleString(undefined, { maximumFractionDigits: 0 });

            // document.getElementById('garchCap').innerText = fmt(m.garch_avg_cap);
            // document.getElementById('garchBreach').innerText = m.garch_breaches + " Days";

            // document.getElementById('lstmCap').innerText = fmt(m.lstm_avg_cap);
            // document.getElementById('lstmBreach').innerText = m.lstm_breaches + " Days";

            // document.getElementById('realCap').innerText = fmt(m.real_avg_cap);

            // const garchDiff = ((m.garch_avg_cap / m.real_avg_cap) - 1) * 100;
            // const lstmDiff = ((m.lstm_avg_cap / m.real_avg_cap) - 1) * 100;

            // document.getElementById('garchEff').innerText = (garchDiff > 0 ? "+" : "") + garchDiff.toFixed(1) + "%";
            // document.getElementById('lstmEff').innerText = (lstmDiff > 0 ? "+" : "") + lstmDiff.toFixed(1) + "%";

            // // Draw Chart
            // const ctx = document.getElementById('riskChart').getContext('2d');
            // if (chart) chart.destroy();

            // // Calculate LOSSES (PnL < 0)
            // // We act as if positive PnL is 0 risk, negative PnL is positive Risk Magnitude
            // const losses = data.plot_data.pnl.map(p => p < 0 ? Math.abs(p) : 0);

            // chart = new Chart(ctx, {
            //     data: {
            //         labels: data.plot_data.dates,
            //         datasets: [
            //             {
            //                 type: 'bar',
            //                 label: 'Daily Loss',
            //                 data: losses,
            //                 backgroundColor: 'rgba(108, 117, 125, 0.4)',
            //                 barPercentage: 0.6,
            //                 order: 4
            //             },
            //             {
            //                 type: 'line',
            //                 label: 'Realized VaR (Historical)',
            //                 data: data.plot_data.real_var,
            //                 borderColor: '#000000', // Black
            //                 borderWidth: 2,
            //                 borderDash: [5, 5], // Dashed
            //                 pointRadius: 0,
            //                 tension: 0.1,
            //                 order: 3
            //             },
            //             {
            //                 type: 'line',
            //                 label: 'GARCH Shield',
            //                 data: data.plot_data.garch_var,
            //                 borderColor: '#dc3545',
            //                 borderWidth: 2,
            //                 pointRadius: 0,
            //                 tension: 0.1,
            //                 order: 2
            //             },
            //             {
            //                 type: 'line',
            //                 label: 'LSTM Shield',
            //                 data: data.plot_data.lstm_var,
            //                 borderColor: '#198754',
            //                 borderWidth: 2,
            //                 pointRadius: 0,
            //                 tension: 0.1,
            //                 order: 1
            //             }
            //         ]
            //     },
            //     options: {
            //         responsive: true,
            //         interaction: { mode: 'index', intersect: false },
            //         plugins: {
            //             tooltip: {
            //                 callbacks: {
            //                     label: function (context) {
            //                         return context.dataset.label + ': $' + Math.round(context.raw).toLocaleString();
            //                     }
            //                 }
            //             }
            //         }
            //     }
            // });

            // document.getElementById('resultsArea').style.display = 'block';
        }
    </script>
    <!-- <script>
        // ... inside runAnalysis() ...

        const m = data.metrics;
        const fmt = (n) => "$" + n.toLocaleString(undefined, {maximumFractionDigits:0});
        
        // Function to check calibration
        function getStatus(rate) {
            if (rate > 2.0) return '<span class="badge bg-danger">Dangerous (>2%)</span>';
            if (rate > 1.0) return '<span class="badge bg-warning text-dark">Slight Breach</span>';
            if (rate === 0) return '<span class="badge bg-info">Conservative (0%)</span>';
            return '<span class="badge bg-success">Calibrated (~1%)</span>';
        }

        // Historical Row
        document.getElementById('histRate').innerText = m.hist_rate.toFixed(1) + "%";
        document.getElementById('histStatus').innerHTML = getStatus(m.hist_rate);
        document.getElementById('histCap').innerText = fmt(m.hist_cap);

        // GARCH Row
        document.getElementById('garchRate').innerText = m.garch_rate.toFixed(1) + "%";
        document.getElementById('garchStatus').innerHTML = getStatus(m.garch_rate);
        document.getElementById('garchCap').innerText = fmt(m.garch_cap);

        // LSTM Row
        document.getElementById('lstmRate').innerText = m.lstm_rate.toFixed(1) + "%";
        document.getElementById('lstmStatus').innerHTML = getStatus(m.lstm_rate);
        document.getElementById('lstmCap').innerText = fmt(m.lstm_cap);

        // Update Chart
        const ctx = document.getElementById('riskChart').getContext('2d');
        if (chart) chart.destroy();

        const losses = data.plot_data.pnl.map(p => p < 0 ? Math.abs(p) : 0);

        chart = new Chart(ctx, {
            data: {
                labels: data.plot_data.dates,
                datasets: [
                    {
                        type: 'bar',
                        label: 'Daily Loss',
                        data: losses,
                        backgroundColor: 'rgba(108, 117, 125, 0.4)',
                        order: 4
                    },
                    {
                        type: 'line',
                        label: 'Historical VaR (Basic)',
                        data: data.plot_data.hist_var,
                        borderColor: '#6c757d', // Grey
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0, // Stair-step often better for Hist VaR, but line is fine
                        order: 3
                    },
                    {
                        type: 'line',
                        label: 'GARCH VaR',
                        data: data.plot_data.garch_var,
                        borderColor: '#dc3545',
                        borderWidth: 2,
                        pointRadius: 0,
                        order: 2
                    },
                    {
                        type: 'line',
                        label: 'LSTM VaR',
                        data: data.plot_data.lstm_var,
                        borderColor: '#198754',
                        borderWidth: 2,
                        pointRadius: 0,
                        order: 1
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    tooltip: { callbacks: { label: (c) => c.dataset.label + ': $' + Math.round(c.raw).toLocaleString() } }
                }
            }
        });
    </script> -->
</body>

</html>